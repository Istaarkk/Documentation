>Def JTAG signifie Join Test Action
>À l’origine, c’est une **norme de test de fabrication** (IEEE 1149.1) pour vérifier les PCB, puis c’est devenu le **standard de programmation et de debug des microcontrôleurs & FPGA**.


JTAG permet :
- de **programmer** un microcontrôleur / FPGA
- de **déboguer** un programme (breakpoints, step-by-step)
- de **tester les connexions** du PCB (boundary scan)
- d’accéder à la mémoire interne

![[Pasted image 20251211141035.png]]

JTAG Broches:

JTAG utilise généralement **4 à 5 broches principales** :

|Nom|Rôle|
|---|---|
|**TCK**|Horloge JTAG|
|**TMS**|Mode / contrôle d'état|
|**TDI**|Données entrantes dans la chaîne|
|**TDO**|Données sortantes|
|**TRST** (optionnel)|Reset du TAP|
→ Ces broches servent à piloter le **TAP Controller**, l’état interne de JTAG.

## Connecteurs courants

- **ARM 20 broches** (2x10 pas 2.54 mm) : historique sur les cartes de dev plus anciennes.  
- **ARM 10 broches** (Cortex, 2x5 pas 1.27 mm) : le plus répandu sur les cartes récentes.  
- **Tag-Connect** : cordons sans connecteur mâle, économisent de la place sur le PCB (footprint à pogo-pins).  
- Toujours soigner la masse : idéalement 2 broches GND côte à côte pour un retour propre.

## Chaîne JTAG et boundary scan

- Les circuits en série forment une **chaîne** : TDO d’un composant vers TDI du suivant.  
- Chaque composant expose un **IDCODE** accessible dès le reset.  
- Le boundary scan permet de tester les liaisons PCB : on force des niveaux logiques sur un composant et on lit sur l’autre.

### Vérifier la chaîne (exemple OpenOCD)

```bash
openocd -f interface/stlink.cfg -f target/stm32f4x.cfg
# Dans un second terminal :
telnet localhost 4444
> jtag arp_init    # init TAPs
> jtag tapisenabled
> dap info         # affiche l'IDCODE si vu
```

Si plusieurs devices sont en série (par ex. FPGA + MCU), fournir chaque TAP dans la config OpenOCD ou utiliser un adaptateur qui expose un **bypass**.

## Débogage et flash

- **Reset** : `> reset init` dans OpenOCD place le MCU dans un état stable.  
- **Flash** : `> program build/firmware.elf verify reset exit` pour écrire et vérifier.  
- **Breakpoints** : on peut fixer des points logiciels (limités par le nombre de comparateurs hardware).  
- Toujours vérifier les options de protection mémoire (RDP, WRP) avant de flasher.

## Bonnes pratiques PCB pour JTAG

- Placer le connecteur en bord de carte et orienter la broche 1 clairement (triangle ou pad carré).  
- Garder les pistes JTAG courtes et groupées, avec une masse proche.  
- Prévoir une résistance pull-up sur TMS et pull-down sur TRST si requis par le MCU/FPGA.  
- Ajouter un **bypass** (soudure ou header 0 Ω) si la chaîne comprend plusieurs devices en série.
